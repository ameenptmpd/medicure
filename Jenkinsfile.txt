pipeline {
    agent any
    
    environment {
		DOCKER = credentials('docker-creds')
        CERT = "$WORKSPACE/certs/${cert_name}"
    }
    stages{
        stage('CLEAN WORKSPACE'){
            steps{
                    cleanWs()
                }
            }
	stage ('git checkout') {
            steps {
                sh 'git clone https://github.com/ameenptmpd/medicure.git'
            }
        }
        stage("k8s-deployment")
		{
			steps{
                withCredentials([string(credentialsId: 'K8S-TOKEN', variable: 'KUBE_API_TOKEN')]) {
                sh '''
                sh $WORKSPACE/medicure/certs/set-k8s-context.sh $KUBE_API_EP $KUBE_API_TOKEN $CERT
                docker pull ameenpt/medicure-app:latest
                kubectl apply -f medicure-service.yaml
                '''
                }
            }
        }
    }
}  
